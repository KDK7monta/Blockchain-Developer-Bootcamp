<!DOCTYPE html>
<html>
  <head>
    <title>Ethereum Provider API - ConsenSys Academy Developer Bootcamp</title>
    <link href="../../../style.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.6.0/gsap.min.js" async></script>
    <script src="../../../text-bounce.js" async></script>
  </head>
  <body>
    <h1 id="ethereum-provider-api">Ethereum Provider API</h1>
<p>Now that you have your smart contract fundamentals down, how about frontend alpha?</p>
<p>The privileges enabled by Web3 are both some of the most promising and challenging in the web development landscape. The ability of users to use digital signatures to validate identity, submit transactions validated without a central authority and interact with a public-state database are extraordinary achievements. But, they also are radically different from the way many users experience the internet.</p>
<p>If you go to any dApp frontend, it knows immediately that you may not have a browser wallet, so it onboards you to one. If it’s your first time using that dApp, it knows you haven’t granted the dApp permission to access your wallet, it prompts you to “Connect”. If you’ve used that dApp before, it knows who you are and shows your address, along with your balances or your NFTs. The reason why your user has access to this sort of functionality, and will, later on, be able to make contract calls, sign messages, and approve transactions is that your dApp will have access to an API called the <a href="https://docs.metamask.io/guide/ethereum-provider.html#ethereum-provider-api" target="_blank">Ethereum Provider API</a>.</p>
<p>If you’ve built a CRUD app with a REST API for a backend, then you had to define a function to make that API call, then supply <code>fetch</code> with an endpoint, and then based on the action you intend for your user to take, your function would use a particular <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods" target="_blank">HTTP method</a>. If your CRUD app was just pulling in data from an API, you’d also have to supply that endpoint to fetch from.</p>
<p>On Web3, we don’t have to do that. We’re not referencing our database with our version of on-chain events, we need the Ethereum blockchain. We need the version of events from the nodes with the longest chain because a blockchain is essentially one massive database.</p>
<h2 id="where-does-this-api-come-from">Where does this API come from?</h2>
<p>On a browser where you have MetaMask installed, open up Chrome Devtools, navigate to <strong>Sources</strong>, and then look at the <strong>Page</strong> panel. If you expand MetaMask, there’s a resource that loads with the page, in the screenshot, it’s <code>inpage.js</code>. </p>
<p><img alt="Chrome Devtools showing " src="../../../img/S04/eth-provider-1.png" /></p>
<p><code>[inpage.js](https://github.com/MetaMask/metamask-extension/blob/43c33b676fe1ecece3e0543eb6ca64d3ae9aa9af/app/scripts/inpage.js){target=\_blank}</code> is a script that tries to declare an object globally in the browser window. If it’s successful, it’ll create a communication stream to 👀 initialize a provider 👀. Once that runs, <code>[contentscript.js](https://github.com/MetaMask/metamask-extension/blob/42c8703f3e3e0fbfddcc9faa4ddb49045ce9631a/app/scripts/contentscript.js){target=\_blank}</code> is executed. And here’s where things get tricky but interesting. On <a href="https://github.com/MetaMask/metamask-extension/blob/42c8703f3e3e0fbfddcc9faa4ddb49045ce9631a/app/scripts/contentscript.js#L45" target="_blank">line 45</a>, there’s an else-if statement that calls a function, seen on <a href="https://github.com/MetaMask/metamask-extension/blob/42c8703f3e3e0fbfddcc9faa4ddb49045ce9631a/app/scripts/contentscript.js#L272" target="_blank">line 272</a>, to check if a provider should be 👀 injected 👀. </p>
<div class="codehilite"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * Determines if the provider should be injected</span>
<span class="cm"> *</span>
<span class="cm"> * @returns {boolean} {@code true} Whether the provider should be injected</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kd">function</span><span class="w"> </span><span class="nx">shouldInjectProvider</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nx">doctypeCheck</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">    </span><span class="nx">suffixCheck</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">    </span><span class="nx">documentElementCheck</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">    </span><span class="o">!</span><span class="nx">blockedDomainCheck</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>This function returns a boolean and checks for conditions like if the window even exists, so if the <code>doctype</code> is HTML (<code>doctypeCheck()</code>), and if it’s an HTML node (<code>documentElementCheck()</code>). It checks if the site URL ends in <code>.xml</code> or <code>.pdf</code> (<code>`suffixCheck()</code>). It checks if the site you’re currently on is not on a list of blocked domains (<code>!blockedDomainCheck()</code>). (<em>Check out some of those <a href="https://github.com/MetaMask/metamask-extension/blob/42c8703f3e3e0fbfddcc9faa4ddb49045ce9631a/app/scripts/contentscript.js#L332" target="_blank">blocked domains</a>. Are some of them familiar? Are you beginning to see a pattern here?</em>) If all conditions pass, then MetaMask knows it can act as a client to facilitate user Web 3 interactions. This is why you get a popup whenever you try to take any action.</p>
<p>The thing to take away here is that we as developers aren’t supplying that API endpoint, or the functionality to interact with it, and it’s for the safety of the user. We’re building around its expected existence, and that’s because MetaMask and other browser wallets, per <a href="https://eips.ethereum.org/EIPS/eip-1193" target="_blank">EIP-1193</a>, globally inject a standard provider interface as a bridge to the Ethereum blockchain into our browser. The browser wallets actually do the heavy lifting by providing the API endpoint. As developers, we just have to call it with <code>window.ethereum</code>. (<em>Provided, we’re not on that blocked domain list, cause we absolutely should not be.</em>)</p>
<p>When you switch to the Console tab, type in <code>window.ethereum</code> to see the Ethereum API methods and properties like <code>isMetaMask</code>, <code>chainId</code> or <code>request()</code>, to name a few.</p>
<p><img alt="Ethereum Provider API methods and properties" src="../../../img/S04/eth-provider-2.png" /></p>
<p>When we call these methods, we submit a “Remote Procedure Call” request to a particular blockchain network. We need to connect to the nodes on a particular network where the target smart contract is deployed, so we’ll need a network RPC endpoint. </p>
<p>For us, it’s an endpoint we can supply to MetaMask to request blockchain data. Does that sound a bit familiar? If you look at the RPC URL I have for Ethereum Mainnet, I’m connected to the Mainnet nodes that are hosted by Infura, who is the default node provider for MetaMask.</p>
<p><img alt="MetaMask Network Settings" src="../../../img/S04/eth-provider-3.png" /></p>
<p>Instead, we use the <code>request()</code> and <code>send()</code> methods. From there, we pass in arguments to determine what we’d like to request. We can use <code>request</code> to:</p>
<ul>
<li>Prompt our user to allow us to view their accounts and balances. Or we can</li>
<li>Prompt them to switch to a particular network, and if they don’t have it configured, we can suggest that network.</li>
<li>If they receive tokens that aren’t on a pre-approved list of recognized tokens,</li>
<li>we can suggest that their <a href="https://eips.ethereum.org/EIPS/eip-747" target="_blank">token can be tracked</a> to show up as an asset in their wallet.</li>
</ul>
<p>You can see the whole list of methods <a href="https://metamask.github.io/api-playground/api-documentation" target="_blank">here</a>. For every single request, MetaMask will pop up asking the user to confirm the action, because the request has to go through MetaMask to the nodes.</p>
<p>In the next lesson we’ll start off by demystifying what it means to “Connect your Wallet”, and how you can achieve that with React and the Ethereum Provider API.</p>
<h2 id="additional-reading">Additional Reading</h2>
<p><a href="https://docs.metamask.io/guide/ethereum-provider.html" target="_blank">Ethereum Provider API</a></p>
<p><a href="https://github.com/MetaMask/providers" target="_blank">Github: MetaMask/Provider</a></p>
    <br /><div class="footer">
    <a href="https://github.com/ConsenSys-Academy/Blockchain-Developer-Bootcamp/edit/staging/docs/S04-developer-tooling/M7-web3-frontend/L1-ethereum-provider-api/index.md" target="_blank">Edit this page on GitHub</a>
    
    <div class="discord">
        <img class="discord-logo" src="../../../discord.svg" alt="Discord logo" ><a href="https://discord.gg/FrHSjSn9dX" target="_blank" >Questions? Ask on Discord! </a>  
    </div> 
</div>
  </body>
</html>